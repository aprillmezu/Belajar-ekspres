"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const router_1 = require("./router");
const router_error_1 = require("../errors/router.error");
const app_1 = require("../app/app");
const supertest_1 = __importDefault(require("supertest"));
const http_error_1 = require("../errors/http.error");
(0, globals_1.describe)('Router', () => {
    (0, globals_1.describe)('path', () => {
        (0, globals_1.test)('throw if path unset', () => {
            const router = new router_1.Router();
            (0, globals_1.expect)(() => router.make()).toThrow(router_error_1.RouterError);
            (0, globals_1.expect)(() => router.make()).toThrow('Path is unset');
        });
        (0, globals_1.test)('set path', () => {
            const router = new router_1.Router();
            router.setPath('/');
            (0, globals_1.expect)(() => router.make()).not.toThrow('Path is unset');
        });
    });
    (0, globals_1.describe)('method', () => {
        (0, globals_1.test)('throw if method unset', () => {
            const router = new router_1.Router();
            router.setPath('/');
            (0, globals_1.expect)(() => router.make()).toThrow(router_error_1.RouterError);
            (0, globals_1.expect)(() => router.make()).toThrow('Method is unset');
        });
        (0, globals_1.test)('set method', () => {
            const router = new router_1.Router();
            router.setPath('/');
            router.setMethod('get');
            (0, globals_1.expect)(() => router.make()).not.toThrow('Method is unset');
        });
    });
    (0, globals_1.describe)('handler', () => {
        (0, globals_1.test)('throw if handler unset', () => {
            const router = new router_1.Router();
            router.setPath('/');
            router.setMethod('get');
            (0, globals_1.expect)(() => router.make()).toThrow(router_error_1.RouterError);
            (0, globals_1.expect)(() => router.make()).toThrow('Handler is unset');
        });
        (0, globals_1.test)('set handler', () => {
            const router = new router_1.Router();
            const handler = globals_1.jest
                .fn()
                .mockResolvedValue('test');
            router.setPath('/');
            router.setMethod('get');
            router.handle(handler);
            (0, globals_1.expect)(() => router.make()).not.toThrow(router_error_1.RouterError);
            (0, globals_1.expect)(() => router.make()).not.toThrow('Handler is unset');
        });
    });
    (0, globals_1.describe)('make', () => {
        (0, globals_1.test)('resolved value', () => __awaiter(void 0, void 0, void 0, function* () {
            const router = new router_1.Router();
            const app = new app_1.App();
            const handler = globals_1.jest
                .fn()
                .mockResolvedValue('test');
            router.setPath('/').setMethod('get').handle(handler);
            app.setRoutes([router.make()]);
            const res = yield (0, supertest_1.default)(app.getServer()).get('/').expect(200);
            (0, globals_1.expect)(res.body).toEqual('test');
            (0, globals_1.expect)(handler).toHaveBeenCalled();
        }));
    });
    (0, globals_1.describe)('handle error', () => {
        (0, globals_1.test)('internal server error', () => __awaiter(void 0, void 0, void 0, function* () {
            const router = new router_1.Router();
            const app = new app_1.App();
            const handler = globals_1.jest
                .fn()
                .mockRejectedValue(new Error('Something Error'));
            router.setPath('/').setMethod('get').handle(handler);
            app.setRoutes([router.make()]);
            const res = yield (0, supertest_1.default)(app.getServer()).get('/').expect(500);
            const errorRes = {
                name: 'Internal Server Error',
                message: 'Something Error',
                status: 500,
            };
            (0, globals_1.expect)(res.body).toEqual(errorRes);
        }));
        (0, globals_1.test)('http error', () => __awaiter(void 0, void 0, void 0, function* () {
            const router = new router_1.Router();
            const app = new app_1.App();
            const handler = globals_1.jest.fn().mockRejectedValue(new http_error_1.HttpError({
                name: 'Forbidden',
                message: 'You dont have access',
            }, 403));
            router.setPath('/').setMethod('get').handle(handler);
            app.setRoutes([router.make()]);
            const res = yield (0, supertest_1.default)(app.getServer()).get('/').expect(403);
            const errorRes = {
                message: 'You dont have access',
                name: 'Forbidden',
                status: 403,
            };
            (0, globals_1.expect)(res.body).toEqual(errorRes);
        }));
    });
    (0, globals_1.describe)('middleware', () => {
        (0, globals_1.test)('handler called', () => __awaiter(void 0, void 0, void 0, function* () {
            const router = new router_1.Router();
            const app = new app_1.App();
            const middlewares = [
                globals_1.jest.fn((req, res, next) => next()),
                globals_1.jest.fn((req, res, next) => next()),
            ];
            router
                .setPath('/')
                .setMethod('post')
                .addMiddlewares(middlewares)
                .handle(() => __awaiter(void 0, void 0, void 0, function* () { return 'Ok'; }));
            app.setRoutes([router.make()]);
            yield (0, supertest_1.default)(app.getServer()).post('/').expect(200);
            (0, globals_1.expect)(middlewares[0]).toHaveBeenCalled();
            (0, globals_1.expect)(middlewares[1]).toHaveBeenCalled();
        }));
    });
});
